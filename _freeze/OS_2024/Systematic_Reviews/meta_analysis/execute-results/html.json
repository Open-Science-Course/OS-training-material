{
  "hash": "4997944225cec771dd38bb06bfa1005a",
  "result": {
    "markdown": "---\ntitle: \"Meta-analysis in R\"\nformat: html\neditor: visual\n---\n\n::: {.cell}\n\n:::\n\n\n## Meta-analysis\n\nMeta-analysis is the quantitative summary of effect sizes extracted from \"published\" sources. A systematic review doesn't have to have a meta-analysis (but a meta-analysis needs a systematic review).\n\n## What is an effect size?\n\nAn effect size is the size of the effect!\n\nThe easiest way to think about them is to think of a classic experiment where we compare the effect of an intervention by using a randomised controlled trial.\n\nWe can simulate some data from a ten experiments (studies) to show the difference between an intervention and a control group. Let's imagine we are studying the effect of a restoration intervention on the species richness of beetles.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data.frame(\n  study_id = c(1:10,10),\n  # Mean species richness in restored and control sites\n  mean_restored = c(12, 15, 14, 20, 8, 13, 16, 19, 10, 18, 17),\n  mean_control = c(9, 12, 11, 15, 10, 11, 14, 17, 9, 14, 14),\n  # Standard deviations for restored and control groups\n  sd_restored = c(2.1, 3.0, 2.5, 3.5, 2.0, 2.8, 3.2, 2.9, 2.3, 3.1, 3),\n  sd_control = c(2.0, 2.9, 2.6, 3.2, 1.9, 2.5, 2.9, 2.7, 2.1, 2.8, 2.7),\n  # Sample sizes for restored and control groups\n  n_restored = c(30, 45, 40, 50, 25, 38, 60, 48, 35, 42, 42),\n  n_control = c(30, 45, 40, 50, 25, 38, 60, 48, 35, 42, 42)\n)\n\ndata |> head()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  study_id mean_restored mean_control sd_restored sd_control n_restored\n1        1            12            9         2.1        2.0         30\n2        2            15           12         3.0        2.9         45\n3        3            14           11         2.5        2.6         40\n4        4            20           15         3.5        3.2         50\n5        5             8           10         2.0        1.9         25\n6        6            13           11         2.8        2.5         38\n  n_control\n1        30\n2        45\n3        40\n4        50\n5        25\n6        38\n```\n:::\n:::\n\n\n### Step 1: Calculating the Standardized Mean Difference (SMD)\n\nThe **standardized mean difference (SMD)** between restored and control sites is calculated as follows:\n\n$$\\text{SMD} = \\frac{\\text{mean}_{\\text{restored}} - \\text{mean}_{\\text{control}}}{\\text{pooled standard deviation}}$$ Where the **pooled standard deviation** is calculated as:\n\n$$2SD_{\\text{pooled}} = \\sqrt{\\frac{(n_{\\text{restored}} - 1) \\cdot SD_{\\text{restored}}^2 + (n_{\\text{control}} - 1) \\cdot SD_{\\text{control}}^2}{n_{\\text{restored}} + n_{\\text{control}} - 2}}$$\n\nLet's calculate this in R:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate pooled standard deviation and SMD for each study\ndata$sd_pooled <- with(data, sqrt(((n_restored - 1) * sd_restored^2 + (n_control - 1) * sd_control^2) / (n_restored + n_control - 2)))\ndata$smd <- with(data, (mean_restored - mean_control) / sd_pooled)\n\n# Calculate variance of the SMD\ndata$smd_variance <- with(data, ((n_restored + n_control) / (n_restored * n_control)) + (smd^2 / (2 * (n_restored + n_control))))\n\n# View the calculated effect sizes and variances\nprint(data[c(\"study_id\", \"smd\", \"smd_variance\")])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   study_id        smd smd_variance\n1         1  1.4629795   0.08450258\n2         2  1.0168031   0.05018827\n3         3  1.1762445   0.05864719\n4         4  1.4910434   0.05111605\n5         5 -1.0253040   0.09051248\n6         6  0.7535108   0.05636696\n7         7  0.6549461   0.03512064\n8         8  0.7138306   0.04432059\n9         9  0.4540766   0.05861561\n10       10  1.3541827   0.05853459\n11       10  1.0511767   0.05419626\n```\n:::\n:::\n\n\nIn ecology we often have small sample sizes, so we use Hedges g to \"correct\" for small samples. In the R package metafor we can calculate this:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhedges_g_data <- metafor::escalc(measure = \"SMD\",\n                        m1i = mean_restored, sd1i = sd_restored, n1i = n_restored,\n                        m2i = mean_control, sd2i = sd_control, n2i = n_control,\n                        data = data)\n\n# View the results\nhedges_g_data |> \n  select(study_id, yi, vi) |> \n  head()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  study_id      yi     vi \n1        1  1.4440 0.0840 \n2        2  1.0081 0.0501 \n3        3  1.1649 0.0585 \n4        4  1.4796 0.0509 \n5        5 -1.0092 0.0902 \n6        6  0.7458 0.0563 \n```\n:::\n:::\n\n\n## Running a meta-analysis\n\n### fixed effects vs random effects\n\nIn meta-analysis, fixed-effects models assume that all studies estimate the same underlying effect size, with any differences among study results being solely due to sampling error. This model is appropriate when we believe that the effect size is constant across all studies, meaning each study measures exactly the same phenomenon.\n\nIn contrast, random-effects models assume that the true effect size varies from study to study due to real differences in study characteristics, such as differences in species, locations, or experimental conditions. Random-effects models treat these variations as random and allow for both within-study sampling error and between-study variability. This is often more realistic in ecology, where conditions across studies are rarely identical.\n\n### Accounting for non-independence\n\nWhere multiple effects come from a single study (or even from related species!) we need to account for non-independence. We can do this in the meta-analysis model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nran_eff_model<-\n  rma.mv(yi, \n         vi, \n         random = ~ 1 | study_id, \n         data = hedges_g_data)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(ran_eff_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nMultivariate Meta-Analysis Model (k = 11; method: REML)\n\n  logLik  Deviance       AIC       BIC      AICc   \n -9.7272   19.4543   23.4543   24.0595   25.1686   \n\nVariance Components:\n\n            estim    sqrt  nlvls  fixed    factor \nsigma^2    0.4078  0.6386     10     no  study_id \n\nTest for Heterogeneity:\nQ(df = 10) = 61.8318, p-val < .0001\n\nModel Results:\n\nestimate      se    zval    pval   ci.lb   ci.ub      \n  0.7940  0.2151  3.6912  0.0002  0.3724  1.2156  *** \n\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n## Forest plot\n\n\n::: {.cell}\n\n```{.r .cell-code}\nforest(ran_eff_model)\n```\n\n::: {.cell-output-display}\n![](meta_analysis_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n## Orchard plots\n\n\n::: {.cell}\n\n```{.r .cell-code}\norchard_plot(ran_eff_model, mod = \"1\", xlab = \"Hedges' g\", angle = 45, group=\"study_id\")\n```\n\n::: {.cell-output-display}\n![](meta_analysis_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n## Pitfalls with Hedges g\n\nIt is very easy to make a mistake in extracting data for calulating the Hedges g. As a \"rule of thumb\" a Hedges g of greater than 5 should be double/tripple checked.\n\n[Here is a link to my Hedges g checker](https://drmatt.shinyapps.io/Hedges_g_checker/)\n\n## Cumulative meta-analysis\n\nA **cumulative meta-analysis** examines how the overall effect size estimate changes as each study is added sequentially, usually sorted by publication date. This approach can reveal trends over time, showing whether the effect size has stabilised as more studies are included.\n\nLet’s go through an example of performing a cumulative meta-analysis with the `metafor` package in R.\n\n### Step 1: Create the Dataset\n\nFirst, we’ll create a dataset with a `year` variable to sort studies in chronological order for the cumulative analysis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data.frame(\n  study_id = 1:10,\n  year = c(2000, 2002, 2004, 2005, 2006, 2008, 2010, 2012, 2015, 2018),  # Publication year\n  yi = c(0.8, 0.7, 0.5, 0.3, 0.1, -0.1, -0.3, -0.5, -0.7, -0.9),  # Effect sizes (Hedges' g)\n  vi = c(0.02, 0.03, 0.025, 0.04, 0.018, 0.027, 0.035, 0.033, 0.02, 0.03)  # Variances\n)\n\n# Sort data by year for cumulative meta-analysis\ndata <- data[order(data$year), ]\n```\n:::\n\n\n### Step 2: Perform Cumulative Meta-Analysis\n\nNow, we can use the `cumul()` function from `metafor` to perform a cumulative meta-analysis. This function recalculates the meta-analysis result each time a new study is added.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit an initial random-effects model \nrandom_effect_model <- rma(yi = yi, vi = vi, data = data, method = \"REML\")  # Perform cumulative meta-analysis \ncumulative_results <- cumul(random_effect_model, order = data$year)  # View cumulative meta-analysis \ncumulative_results\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n   estimate     se    zval  pvals   ci.lb  ci.ub        Q     Qp   tau2      I2 \n1    0.8000 0.1414  5.6569 0.0000  0.5228 1.0772   0.0000 1.0000 0.0000  0.0000 \n2    0.7600 0.1095  6.9378 0.0000  0.5453 0.9747   0.2000 0.6547 0.0000  0.0000 \n3    0.6748 0.0938  7.1978 0.0000  0.4911 0.8586   2.0270 0.3629 0.0020  7.4829 \n4    0.5986 0.1060  5.6447 0.0000  0.3907 0.8064   4.9607 0.1747 0.0174 38.6738 \n5    0.4802 0.1343  3.5758 0.0003  0.2170 0.7434  15.5708 0.0037 0.0642 71.9936 \n6    0.3842 0.1449  2.6517 0.0080  0.1002 0.6681  25.8529 0.0001 0.0997 79.8004 \n7    0.2904 0.1548  1.8756 0.0607 -0.0131 0.5939  37.8277 0.0000 0.1403 84.2217 \n8    0.1927 0.1661  1.1607 0.2458 -0.1327 0.5182  55.7933 0.0000 0.1923 87.7058 \n9    0.0898 0.1780  0.5047 0.6138 -0.2590 0.4387  92.8590 0.0000 0.2578 90.8532 \n10  -0.0087 0.1871 -0.0462 0.9631 -0.3754 0.3581 123.1155 0.0000 0.3224 92.4608 \n        H2 \n1   1.0000 \n2   1.0000 \n3   1.0809 \n4   1.6306 \n5   3.5706 \n6   4.9506 \n7   6.3378 \n8   8.1339 \n9  10.9328 \n10 13.2640 \n```\n:::\n:::\n\n\n### Step 3: Plot the Cumulative Meta-Analysis\n\nYou can also visualize the cumulative effect size estimates over time using `forest()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot cumulative meta-analysis results \nforest(cumulative_results, xlab = \"Cumulative Hedges' g\", refline = 0, cex = 0.8)\n```\n\n::: {.cell-output-display}\n![](meta_analysis_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n### Interpretation\n\nAs you add each study (from the earliest to the most recent), you’ll see how the cumulative estimate of Hedges' g changes. In ecology, this can highlight if early results were consistent with later studies or if new findings led to significant shifts in the overall effect estimate. This approach provides insight into whether further studies are likely to meaningfully alter the cumulative effect size or if it has stabilised.\n",
    "supporting": [
      "meta_analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}